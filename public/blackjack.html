<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Service Blackjack - Dynatrace Observatory</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'dt-purple': '#6C2C9C',
                        'dt-blue': '#00A1C9',
                        'dt-cyan': '#00D4FF',
                        'dt-green': '#73BE28',
                        'dt-orange': '#FFA86B',
                        'dt-yellow': '#FFD23F',
                        'dt-dark': '#151515',
                        'dt-darker': '#0A0A0A',
                        'dt-gray': '#2D2D2D',
                        'dt-light-gray': '#4A4A4A'
                    }
                }
            }
        }
    </script>
    
    <!-- External libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    
    <style>
        /* Blackjack specific styles */
        .blackjack-bg {
            background: 
                radial-gradient(circle at 10% 20%, rgba(108, 44, 156, 0.2) 0%, transparent 50%),
                radial-gradient(circle at 90% 80%, rgba(0, 212, 255, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 50% 50%, rgba(115, 190, 40, 0.05) 0%, transparent 60%),
                linear-gradient(135deg, #0A0A0A 0%, #151515 100%);
        }
        
        .blackjack-table {
            background: 
                radial-gradient(circle at 30% 30%, rgba(108, 44, 156, 0.1) 0%, transparent 40%),
                radial-gradient(circle at 70% 70%, rgba(0, 212, 255, 0.08) 0%, transparent 50%),
                linear-gradient(145deg, rgba(21, 21, 21, 0.95), rgba(45, 45, 45, 0.8));
            border: 4px solid transparent;
            background-clip: padding-box;
            box-shadow: 
                0 0 0 2px #6C2C9C,
                0 20px 60px rgba(0, 0, 0, 0.8),
                0 0 40px rgba(108, 44, 156, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            position: relative;
            overflow: hidden;
        }
        
        .blackjack-table::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 30%, rgba(255, 215, 0, 0.08) 0%, transparent 40%),
                radial-gradient(circle at 80% 70%, rgba(218, 165, 32, 0.06) 0%, transparent 35%);
            pointer-events: none;
        }
        
        .card {
            width: 80px;
            height: 120px;
            border-radius: 12px;
            position: relative;
            background: linear-gradient(145deg, #ffffff, #f0f0f0);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: bold;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 6px;
            margin: 2px;
        }
        
        .card.red {
            color: #dc2626;
        }
        
        .card.black {
            color: #1f2937;
        }
        
        .card.card-back {
            background: linear-gradient(145deg, #6C2C9C, #4A1D6E);
            color: #FFD23F;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
        }
        
        .card.dealing {
            animation: dealCard 0.5s ease-out;
        }
        
        .card.flipping {
            animation: flipCard 0.6s ease-in-out;
        }
        
        @keyframes dealCard {
            from {
                transform: translateY(-100px) rotate(-10deg);
                opacity: 0;
            }
            to {
                transform: translateY(0) rotate(0deg);
                opacity: 1;
            }
        }
        
        @keyframes flipCard {
            0% { transform: rotateY(0deg); }
            50% { transform: rotateY(90deg); }
            100% { transform: rotateY(0deg); }
        }
        
        .card {
            color: #000000;
        }
        
        .card-back {
            background: linear-gradient(145deg, #6C2C9C, #4A1A6E);
            color: #ffffff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        
        .card.dealing {
            animation: card-deal 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        
        @keyframes card-deal {
            0% {
                transform: translateY(-100px) rotate(180deg);
                opacity: 0;
            }
            60% {
                transform: translateY(10px) rotate(10deg);
                opacity: 0.8;
            }
            100% {
                transform: translateY(0) rotate(0deg);
                opacity: 1;
            }
        }
        
        .card.flipping {
            animation: card-flip 0.6s ease-in-out;
        }
        
        @keyframes card-flip {
            0% { transform: rotateY(0deg); }
            50% { transform: rotateY(90deg); }
            100% { transform: rotateY(0deg); }
        }
        
        .hand-area {
            min-height: 140px;
            padding: 20px;
            border: 2px solid transparent;
            background-clip: padding-box;
            border-radius: 16px;
            background: 
                radial-gradient(circle at 25% 25%, rgba(255, 255, 255, 0.15) 0%, transparent 40%),
                linear-gradient(180deg, #2D2D2D 0%, #1A1A1A 30%, #2D2D2D 70%, #1A1A1A 100%);
            box-shadow: 
                0 0 0 2px #8B4513,
                inset 0 4px 15px rgba(0, 0, 0, 0.9),
                inset 0 -4px 15px rgba(139, 69, 19, 0.3),
                0 8px 25px rgba(0, 0, 0, 0.6),
                0 0 20px rgba(139, 69, 19, 0.4);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .hand-area.active {
            border-color: #73BE28;
            background: 
                radial-gradient(circle at 25% 25%, rgba(115, 190, 40, 0.2) 0%, transparent 40%),
                linear-gradient(180deg, #2D2D2D 0%, #1A1A1A 30%, #2D2D2D 70%, #1A1A1A 100%);
            box-shadow: 
                0 0 0 2px #73BE28,
                0 0 30px rgba(115, 190, 40, 0.6),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }
        
        .chip {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 12px;
            border: 3px solid;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);
        }
        
        .chip-5 {
            background: linear-gradient(145deg, #dc2626, #991b1b);
            border-color: #7f1d1d;
            color: white;
        }
        
        .chip-10 {
            background: linear-gradient(145deg, #2563eb, #1d4ed8);
            border-color: #1e40af;
            color: white;
        }
        
        .chip-25 {
            background: linear-gradient(145deg, #16a34a, #15803d);
            border-color: #166534;
            color: white;
        }
        
        .chip-50 {
            background: linear-gradient(145deg, #7c3aed, #6d28d9);
            border-color: #5b21b6;
            color: white;
        }
        
        .chip-100 {
            background: linear-gradient(145deg, #000000, #404040);
            border-color: #262626;
            color: white;
        }
        
        .chip:hover {
            transform: scale(1.1) translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
        }
        
        .action-button {
            background: linear-gradient(145deg, rgba(115, 190, 40, 0.8), rgba(115, 190, 40, 0.6));
            border: 2px solid #73BE28;
            border-radius: 12px;
            padding: 12px 24px;
            font-weight: bold;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            font-size: 14px;
            letter-spacing: 0.5px;
        }
        
        .action-button:hover:not(:disabled) {
            background: linear-gradient(145deg, #73BE28, rgba(115, 190, 40, 0.8));
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(115, 190, 40, 0.4);
        }
        
        .action-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .score-display {
            background: 
                radial-gradient(circle at 30% 30%, rgba(108, 44, 156, 0.1) 0%, transparent 40%),
                radial-gradient(circle at 70% 70%, rgba(0, 212, 255, 0.08) 0%, transparent 50%),
                linear-gradient(145deg, rgba(21, 21, 21, 0.95), rgba(45, 45, 45, 0.9));
            border: 2px solid transparent;
            background-clip: padding-box;
            backdrop-filter: blur(15px);
            box-shadow: 
                0 0 0 1px rgba(108, 44, 156, 0.3),
                0 8px 25px rgba(0, 0, 0, 0.6),
                0 0 20px rgba(108, 44, 156, 0.2);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
        }
        
        .score-display.bust {
            border-color: #dc2626;
            background: linear-gradient(145deg, rgba(220, 38, 38, 0.2), rgba(45, 45, 45, 0.8));
        }
        
        .score-display.blackjack {
            border-color: #FFD23F;
            background: linear-gradient(145deg, rgba(255, 210, 63, 0.2), rgba(45, 45, 45, 0.8));
            animation: pulse-gold 2s infinite;
        }
        
        @keyframes pulse-gold {
            0%, 100% { box-shadow: 0 0 0 rgba(255, 210, 63, 0.4); }
            50% { box-shadow: 0 0 20px rgba(255, 210, 63, 0.8); }
        }
        
        .betting-area {
            background: linear-gradient(145deg, rgba(45, 45, 45, 0.8), rgba(21, 21, 21, 0.9));
            border: 2px solid rgba(115, 190, 40, 0.3);
            border-radius: 16px;
            padding: 20px;
        }
        
        .strategy-hint {
            background: rgba(108, 44, 156, 0.1);
            border: 1px solid rgba(108, 44, 156, 0.3);
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 12px;
            color: #d8b4fe;
        }
        
        .game-status {
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: bold;
        }
        
        .metric-value {
            background: linear-gradient(45deg, #00D4FF, #6C2C9C, #73BE28);
            background-size: 300% 300%;
            animation: metric-shimmer 3s ease-in-out infinite;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        @keyframes metric-shimmer {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        
        /* Side Panel Styles */
        .side-panel {
            background: 
                radial-gradient(circle at 20% 30%, rgba(108, 44, 156, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(0, 212, 255, 0.1) 0%, transparent 40%),
                linear-gradient(145deg, rgba(21, 21, 21, 0.98), rgba(45, 45, 45, 0.95));
            backdrop-filter: blur(20px);
            box-shadow: 
                2px 0 20px rgba(0, 0, 0, 0.8),
                0 0 40px rgba(108, 44, 156, 0.3),
                inset -1px 0 0 rgba(0, 212, 255, 0.2);
        }
        
        .side-panel-open {
            transform: translateX(0) !important;
        }
        
        .main-content-shifted {
            margin-left: 320px;
        }
        
        .config-toggle-btn {
            background: 
                radial-gradient(circle at 25% 25%, rgba(108, 44, 156, 0.9) 0%, rgba(75, 31, 111, 0.9) 70%),
                linear-gradient(145deg, rgba(108, 44, 156, 0.8), rgba(45, 45, 45, 0.6));
            box-shadow: 
                0 4px 15px rgba(0, 0, 0, 0.7),
                0 0 20px rgba(108, 44, 156, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            writing-mode: vertical-rl;
            text-orientation: mixed;
        }
        
        .config-toggle-btn:hover {
            background: 
                radial-gradient(circle at 25% 25%, rgba(108, 44, 156, 1) 0%, rgba(75, 31, 111, 1) 70%),
                linear-gradient(145deg, rgba(108, 44, 156, 0.9), rgba(45, 45, 45, 0.7));
            box-shadow: 
                0 6px 20px rgba(0, 0, 0, 0.8),
                0 0 30px rgba(108, 44, 156, 0.6),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }
        
        /* Responsive Layout System */
        .responsive-layout {
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .responsive-header {
            height: clamp(60px, 8vh, 80px);
            flex-shrink: 0;
        }
        
        .responsive-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
            overflow: hidden;
        }
        
        .game-grid {
            height: 100%;
            display: grid;
            grid-template-rows: 1fr auto;
            grid-template-columns: 1fr;
            overflow: hidden;
            position: relative;
        }
        
        /* Side Analytics Panel */
        .side-analytics {
            position: absolute;
            top: 2rem;
            right: 2rem;
            width: 280px;
            z-index: 10;
            pointer-events: auto;
        }
        
        .metrics-panel {
            background: 
                linear-gradient(135deg, rgba(17, 17, 19, 0.95) 0%, rgba(29, 29, 35, 0.95) 100%),
                linear-gradient(45deg, rgba(108, 44, 156, 0.1) 0%, rgba(0, 212, 255, 0.1) 100%);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(108, 44, 156, 0.3);
            box-shadow: 
                0 20px 40px rgba(0, 0, 0, 0.4),
                0 0 30px rgba(108, 44, 156, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }
        
        .metric-value {
            color: #00d4ff;
            text-shadow: 0 0 8px rgba(0, 212, 255, 0.6);
        }
        
        /* Main Game Area */
        .main-game-area {
            display: flex;
            flex-direction: column;
            min-height: 0;
        }
    </style>
</head>
<body class="responsive-layout blackjack-bg text-white font-sans">
    
    <!-- Header -->
    <header class="responsive-header bg-dt-dark/90 backdrop-blur-md border-b border-dt-cyan/20">
        <div class="max-w-7xl mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4 ml-16">
                    <button onclick="window.location.href='lobby.html'" class="bg-dt-gray hover:bg-dt-light-gray text-white px-4 py-2 rounded-lg font-semibold text-sm">
                        ‚Üê Lobby
                    </button>
                    <div>
                        <h1 class="text-xl font-bold text-dt-green">‚ô†Ô∏è Service Blackjack</h1>
                        <p class="text-xs text-dt-light-gray">Dynatrace Observatory</p>
                    </div>
                </div>
                
                <!-- User info and balance -->
                <div class="flex items-center space-x-4">
                    <div class="bg-dt-dark/60 border border-dt-cyan/20 rounded-lg px-4 py-2">
                        <div class="flex items-center space-x-4 text-sm">
                            <div class="flex items-center space-x-2">
                                <div class="w-2 h-2 bg-dt-green rounded-full animate-pulse"></div>
                                <span class="text-dt-cyan">Agent:</span>
                                <span id="agentName" class="font-mono text-white">Loading...</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="text-dt-cyan">Balance:</span>
                                <span id="balanceDisplay" class="font-mono text-dt-yellow font-semibold">$0</span>
                            </div>
                            <button onclick="addFunds()" class="bg-dt-green hover:bg-dt-green/80 text-white px-3 py-1 rounded text-xs font-semibold transition-colors">
                                Deposit
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Collapsible Side Panel for Cheat Configuration -->
    <div id="cheatSidePanel" class="fixed left-0 top-0 h-full w-80 side-panel transform -translate-x-full transition-transform duration-300 ease-in-out z-40">
        <div class="p-6 h-full overflow-y-auto">
            <!-- Panel Header -->
            <div class="flex items-center justify-between mb-6 pb-4 border-b border-dt-light-gray/20">
                <div class="flex items-center space-x-3">
                    <div class="w-3 h-3 bg-dt-purple rounded-full animate-pulse"></div>
                    <h3 class="text-lg font-bold text-dt-cyan">‚öôÔ∏è Configuration Lab</h3>
                </div>
                <button id="closeSidePanel" onclick="toggleCheatSidePanel()" class="text-dt-light-gray hover:text-white transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Configuration Content -->
            <div class="space-y-6">
                <!-- Demo Methods Section -->
                <div class="bg-dt-darker/60 rounded-lg p-4 border border-dt-purple/30">
                    <div class="text-center mb-4">
                        <h4 class="text-dt-purple font-bold text-md mb-1">Demo Enhancement Methods</h4>
                        <div class="text-xs text-gray-400">Laboratory environment - All methods unlocked</div>
                        <div class="text-xs text-dt-green mt-1 bg-green-900/30 px-2 py-1 rounded">‚úì Free Testing Mode</div>
                    </div>
                    
                    <div class="space-y-3">
                        <button id="cheatCardCounting" class="w-full cheat-button bg-green-900/30 hover:bg-green-800/50 border border-green-500/50 text-green-300 px-4 py-3 rounded-lg text-sm font-semibold transition-all text-left" onclick="activateCheat('cardCounting')">
                            <div class="flex items-center justify-between mb-1">
                                <span class="flex items-center space-x-2">
                                    <span>üßÆ</span>
                                    <span>Advanced Card Counting</span>
                                </span>
                                <span class="text-xs text-green-400 bg-green-900/50 px-2 py-1 rounded">FREE</span>
                            </div>
                            <div class="text-xs text-green-400/70 ml-6">Perfect card tracking and probability calculation (+45% win rate)</div>
                        </button>
                        
                        <button id="cheatDealerTell" class="w-full cheat-button bg-green-900/30 hover:bg-green-800/50 border border-green-500/50 text-green-300 px-4 py-3 rounded-lg text-sm font-semibold transition-all text-left" onclick="activateCheat('dealerTell')">
                            <div class="flex items-center justify-between mb-1">
                                <span class="flex items-center space-x-2">
                                    <span>ÔøΩÔ∏è</span>
                                    <span>Dealer Pattern Recognition</span>
                                </span>
                                <span class="text-xs text-green-400 bg-green-900/50 px-2 py-1 rounded">FREE</span>
                            </div>
                            <div class="text-xs text-green-400/70 ml-6">Read dealer behavioral patterns and tells (+35% win rate)</div>
                        </button>
                        
                        <button id="cheatDeckStacking" class="w-full cheat-button bg-green-900/30 hover:bg-green-800/50 border border-green-500/50 text-green-300 px-4 py-3 rounded-lg text-sm font-semibold transition-all text-left" onclick="activateCheat('deckStacking')">
                            <div class="flex items-center justify-between mb-1">
                                <span class="flex items-center space-x-2">
                                    <span>üÉè</span>
                                    <span>Favorable Card Sequencing</span>
                                </span>
                                <span class="text-xs text-green-400 bg-green-900/50 px-2 py-1 rounded">FREE</span>
                            </div>
                            <div class="text-xs text-green-400/70 ml-6">Influence card order for favorable hands (+50% win rate)</div>
                        </button>
                        
                        <button id="cheatBasicStrategyPerfect" class="w-full cheat-button bg-green-900/30 hover:bg-green-800/50 border border-green-500/50 text-green-300 px-4 py-3 rounded-lg text-sm font-semibold transition-all text-left" onclick="activateCheat('basicStrategyPerfect')">
                            <div class="flex items-center justify-between mb-1">
                                <span class="flex items-center space-x-2">
                                    <span>üéØ</span>
                                    <span>Perfect Strategy Engine</span>
                                </span>
                                <span class="text-xs text-green-400 bg-green-900/50 px-2 py-1 rounded">FREE</span>
                            </div>
                            <div class="text-xs text-green-400/70 ml-6">AI-powered optimal decision making for every hand (+40% win rate)</div>
                        </button>
                        
                        <button onclick="deactivateCheat()" class="w-full bg-red-800/60 hover:bg-red-700/70 border border-red-500/50 text-white text-sm py-3 px-4 rounded-lg transition-all font-semibold">
                            üõë Reset to Baseline Configuration
                        </button>
                    </div>
                    
                    <div id="cheatStatus" class="text-center text-xs text-gray-400 mt-4 pt-4 border-t border-gray-700/50">
                        üî¨ Observatory Mode - Baseline Configuration Active
                    </div>
                </div>
                
                <!-- Status Information -->
                <div class="bg-dt-darker/40 rounded-lg p-4 border border-dt-cyan/20">
                    <h4 class="text-dt-cyan font-semibold text-sm mb-2">üìä Current Session Status</h4>
                    <div class="space-y-2 text-xs">
                        <div class="flex justify-between">
                            <span class="text-dt-light-gray">Enhancement Active:</span>
                            <span id="sidePanelCheatStatus" class="text-dt-yellow">None</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-dt-light-gray">Performance Boost:</span>
                            <span id="sidePanelBoostLevel" class="text-dt-green">Baseline</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-dt-light-gray">Demo Duration:</span>
                            <span class="text-dt-cyan">30 seconds</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Side Panel Toggle Button -->
    <button id="cheatToggleBtn" onclick="toggleCheatSidePanel()" class="fixed left-4 top-4 config-toggle-btn text-white p-3 rounded-lg shadow-lg transition-all duration-300 z-30">
        <div class="flex flex-col items-center space-y-1">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4"></path>
            </svg>
            <div class="text-xs font-semibold">Enable Cheats</div>
        </div>
    </button>

    <!-- Main Game Area -->
    <main id="mainGameArea" class="responsive-main transition-all duration-300">
        <div class="game-grid">
            <!-- Main Blackjack Game Area -->
            <div class="main-game-area h-full">
                <div class="h-full flex relative">
                    <!-- Side Analytics (Floating) -->
                    <div class="side-analytics">
                       
                            </div>
                        </div>
                    </div>

                    <!-- Main Game Area -->
                    <div class="flex-1 p-6">
                        <div class="h-full flex flex-col justify-center">
                            <!-- Blackjack Table -->
                            <div class="blackjack-table rounded-3xl p-8 h-full flex flex-col justify-center">
                        
                        <!-- Dealer Section -->
                        <div class="mb-8">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-xl font-bold text-dt-green">Dealer</h2>
                                <div class="score-display" id="dealerScoreDisplay">
                                    <div class="text-2xl font-bold text-dt-green" id="dealerScore">0</div>
                                    <div class="text-xs text-dt-light-gray">Score</div>
                                </div>
                            </div>
                            <div class="hand-area" id="dealerHand">
                                <div class="flex flex-wrap justify-center gap-2" id="dealerCards">
                                    <!-- Dealer cards will be added here -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- Game Status -->
                        <div class="game-status mb-8" id="gameStatus">
                            <span class="text-dt-cyan">Welcome to Service Blackjack! Deploy your stack to start.</span>
                        </div>
                        
                        <!-- Player Section -->
                        <div class="mb-8">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-xl font-bold text-dt-cyan">Player</h2>
                                <div class="score-display" id="playerScoreDisplay">
                                    <div class="text-2xl font-bold text-dt-cyan" id="playerScore">0</div>
                                    <div class="text-xs text-dt-light-gray">Score</div>
                                </div>
                            </div>
                            <div class="hand-area" id="playerHand">
                                <div class="flex flex-wrap justify-center gap-2" id="playerCards">
                                    <!-- Player cards will be added here -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- Control Panel -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            
                            <!-- Betting Area -->
                            <div class="betting-area">
                                <h3 class="text-dt-green font-semibold mb-4">Betting Chips</h3>
                                <div class="flex justify-center space-x-4 mb-4">
                                    <div class="chip chip-5" onclick="setBet(5)">$5</div>
                                    <div class="chip chip-10" onclick="setBet(10)">$10</div>
                                    <div class="chip chip-25" onclick="setBet(25)">$25</div>
                                    <div class="chip chip-50" onclick="setBet(50)">$50</div>
                                    <div class="chip chip-100" onclick="setBet(100)">$100</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-dt-light-gray mb-2">Current Bet:</div>
                                    <div class="text-2xl font-bold text-dt-yellow" id="currentBet">$0</div>
                                </div>
                            </div>
                            
                            <!-- Action Buttons -->
                            <div class="betting-area">
                                <h3 class="text-dt-green font-semibold mb-4">Game Actions</h3>
                                <div class="grid grid-cols-2 gap-3">
                                    <button class="action-button" id="dealButton" onclick="startNewHand()">
                                        Deal Cards
                                    </button>
                                    <button class="action-button" id="hitButton" onclick="playerHit()" disabled>
                                        Hit
                                    </button>
                                    <button class="action-button" id="standButton" onclick="playerStand()" disabled>
                                        Stand
                                    </button>
                                    <button class="action-button" id="doubleButton" onclick="playerDouble()" disabled>
                                        Double Down
                                    </button>
                                </div>
                                <button class="action-button w-full mt-3" id="clearButton" onclick="clearBet()">
                                    Clear Bet
                                </button>
                            </div>
                        </div>
                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
            </div>
        </div>
        </div>
    </main>

    <script>
        // Initialize Socket.IO
        const socket = io();
        
        // Check if user has the new required fields, if not populate with defaults
        function ensureUserProfileComplete() {
            const currentUser = localStorage.getItem('vegas.username') || localStorage.getItem('vegasUser') || 'Anonymous';
            const requiredFields = {
                'vegas.customerName': currentUser,
                'vegas.email': 'user@example.com',
                'vegas.companyName': 'Dynatrace',
                'vegas.persona': 'Customer',
                'vegas.booth': 'Business Analytics',
                'vegas.optIn': 'true'
            };
            
            let updated = false;
            for (const [key, defaultValue] of Object.entries(requiredFields)) {
                if (!localStorage.getItem(key)) {
                    localStorage.setItem(key, defaultValue);
                    updated = true;
                }
            }
            
            if (updated) {
                console.log('Auto-populated missing user profile fields with defaults');
            }
        }
        
        // Ensure profile is complete when game loads
        ensureUserProfileComplete();
        
        // Blackjack-specific cheat methods
        const cheatMethods = {
            cardCounting: {
                name: 'Advanced Card Counting',
                cost: 175,
                winBoost: 45,
                detectionRisk: 20,
                description: 'Perfect card tracking and probability calculation'
            },
            dealerTell: {
                name: 'Dealer Pattern Recognition',
                cost: 125,
                winBoost: 35,
                detectionRisk: 15,
                description: 'Read dealer behavioral patterns and tells'
            },
            deckStacking: {
                name: 'Favorable Card Sequencing',
                cost: 225,
                winBoost: 50,
                detectionRisk: 25,
                description: 'Influence card order for favorable hands'
            },
            basicStrategyPerfect: {
                name: 'Perfect Strategy Engine',
                cost: 150,
                winBoost: 40,
                detectionRisk: 18,
                description: 'AI-powered optimal decision making for every hand'
            }
        };
        
        // Cheat state management
        let cheatState = {
            active: null,
            winRateBoost: 0,
            detectionRisk: 0
        };
        
        // Side panel toggle for cheat controls
        let sidePanelOpen = false;
        
        function toggleCheatSidePanel() {
            const sidePanel = document.getElementById('cheatSidePanel');
            const mainGameArea = document.getElementById('mainGameArea');
            const toggleBtn = document.getElementById('cheatToggleBtn');
            
            if (!sidePanel) return;
            
            sidePanelOpen = !sidePanelOpen;
            
            if (sidePanelOpen) {
                // Show side panel
                sidePanel.classList.add('side-panel-open');
                if (mainGameArea) mainGameArea.classList.add('main-content-shifted');
                if (toggleBtn) toggleBtn.style.left = '324px'; // 320px panel width + 4px margin
                
                console.log('üéØ Configuration Lab opened');
            } else {
                // Hide side panel
                sidePanel.classList.remove('side-panel-open');
                if (mainGameArea) mainGameArea.classList.remove('main-content-shifted');
                if (toggleBtn) toggleBtn.style.left = '16px'; // Reset to original position
                
                console.log('üéØ Configuration Lab closed');
            }
        }
        
        // Cheat activation functions
        function activateCheat(cheatType) {
            const cheat = cheatMethods[cheatType];
            if (!cheat) return;
            
            cheatState.active = cheatType;
            cheatState.winBoost = cheat.winBoost;
            cheatState.detectionRisk = cheat.detectionRisk;
            
            updateCheatUI();
            showNotification(`üöÄ ${cheat.name} activated! Win boost: +${cheat.winBoost}%`, 'success');
            
            // Auto-deactivate after 30 seconds
            setTimeout(() => {
                if (cheatState.active === cheatType) {
                    deactivateCheat();
                }
            }, 30000);
        }
        
        function deactivateCheat() {
            if (!cheatState.active) return;
            
            cheatState.active = null;
            cheatState.winBoost = 0;
            updateCheatUI();
            showMessage('üîÑ Configuration reset to baseline', 'info');
        }
        
        function updateCheatUI() {
            const buttons = ['cheatCardCounting', 'cheatDealerTell', 'cheatDeckStacking', 'cheatBasicStrategyPerfect'];
            const types = ['cardCounting', 'dealerTell', 'deckStacking', 'basicStrategyPerfect'];
            
            buttons.forEach((buttonId, index) => {
                const button = document.getElementById(buttonId);
                if (!button) return;
                
                const cheatType = types[index];
                const cheat = cheatMethods[cheatType];
                
                if (cheatState.active === cheatType) {
                    button.classList.add('bg-red-600', 'animate-pulse');
                    button.innerHTML = `
                        <div class="flex items-center justify-between">
                            <span>üî• ACTIVE</span>
                            <span class="text-xs text-red-400">ACTIVE</span>
                        </div>
                        <div class="text-xs text-red-400/70 mt-1">${cheat.name} Running</div>
                    `;
                } else {
                    button.classList.remove('bg-red-600', 'animate-pulse');
                    const icons = ['üßÆ', 'üëÅÔ∏è', 'üÉè', 'üéØ'];
                    button.innerHTML = `
                        <div class="flex items-center justify-between">
                            <span>${icons[index]} ${cheat.name.split(' ')[0]}</span>
                            <span class="text-xs text-green-400">FREE</span>
                        </div>
                        <div class="text-xs text-green-400/70 mt-1">+${cheat.winBoost}% win rate</div>
                    `;
                }
            });
            
            // Update status
            const statusEl = document.getElementById('cheatStatus');
            if (statusEl) {
                if (cheatState.active) {
                    const activeCheat = cheatMethods[cheatState.active];
                    statusEl.innerHTML = `üî• ${activeCheat.name} Active`;
                    statusEl.className = 'text-center text-xs text-red-300 mt-4 pt-4 border-t border-gray-700/50';
                } else {
                    statusEl.innerHTML = 'üî¨ Observatory Mode - Baseline Configuration Active';
                    statusEl.className = 'text-center text-xs text-gray-400 mt-4 pt-4 border-t border-gray-700/50';
                }
            }
            
            // Update side panel status indicators
            const sidePanelCheatStatus = document.getElementById('sidePanelCheatStatus');
            const sidePanelBoostLevel = document.getElementById('sidePanelBoostLevel');
            
            if (sidePanelCheatStatus && sidePanelBoostLevel) {
                if (cheatState.active) {
                    const activeCheat = cheatMethods[cheatState.active];
                    sidePanelCheatStatus.textContent = activeCheat.name;
                    sidePanelCheatStatus.className = 'text-red-400';
                    sidePanelBoostLevel.textContent = `+${activeCheat.winBoost}%`;
                    sidePanelBoostLevel.className = 'text-red-400';
                } else {
                    sidePanelCheatStatus.textContent = 'None';
                    sidePanelCheatStatus.className = 'text-dt-yellow';
                    sidePanelBoostLevel.textContent = 'Baseline';
                    sidePanelBoostLevel.className = 'text-dt-green';
                }
            }
        }

        // Game state
        let gameState = 'waiting'; // waiting, playing, dealer_turn, finished
        let playerHand = [];
        let dealerHand = [];
        let currentBet = 0;
        let gameStats = {
            totalHands: 0,
            totalWins: 0,
            totalBlackjacks: 0,
            totalPushes: 0,
            netProfit: 0,
            recentHands: []
        };
        let deckStats = {
            cardsDealt: 0,
            highCards: 16, // 10, J, Q, K, A
            lowCards: 20,  // 2-6
            runningCount: 0
        };
        
        function setBet(amount) {
            if (gameState !== 'waiting') return;
            
            const currentBalance = parseInt((document.getElementById('balanceDisplay').textContent || '0').replace(/[^0-9]/g, '')) || 0;
            const newTotalBet = currentBet + amount;
            
            if (currentBalance < newTotalBet) {
                showNotification('üí≥ Insufficient DT Credits for this bet!', 'error');
                return;
            }
            
            // Add to existing bet (stack chips)
            currentBet = newTotalBet;
            document.getElementById('currentBet').textContent = `$${currentBet}`;
            
            // Animate the clicked chip
            event.target.style.transform = 'scale(1.2)';
            event.target.style.boxShadow = '0 0 20px rgba(115, 190, 40, 0.8)';
            
            // Reset animation after a moment
            setTimeout(() => {
                event.target.style.transform = 'scale(1)';
                event.target.style.boxShadow = '';
            }, 300);
            
            // Show feedback
            showNotification(`Added $${amount} chip! Total bet: $${currentBet}`, 'success');
            
            // Update button immediately
            updateActionButtons();
            updateStrategyHint();
        }
        
        function clearBet() {
            if (gameState !== 'waiting') return;
            
            currentBet = 0;
            document.getElementById('currentBet').textContent = '$0';
            
            document.querySelectorAll('.chip').forEach(chip => {
                chip.style.transform = 'scale(1)';
                chip.style.boxShadow = '';
            });
            
            updateStrategyHint();
        }
        
        // Local deck management
        let deck = [];
        
        function createDeck() {
            const suits = ['‚ô†', '‚ô£', '‚ô•', '‚ô¶'];
            const ranks = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13]; // 1=Ace, 11=Jack, 12=Queen, 13=King
            deck = [];
            
            for (let suit of suits) {
                for (let rank of ranks) {
                    deck.push({ suit, rank });
                }
            }
            
            // Shuffle deck
            for (let i = deck.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [deck[i], deck[j]] = [deck[j], deck[i]];
            }
        }
        
        function drawCard() {
            if (deck.length < 10) {
                createDeck(); // Reshuffle when low
            }
            return deck.pop();
        }
        
        async function startNewHand() {
            if (gameState !== 'waiting' || currentBet === 0) {
                if (currentBet === 0) {
                    showNotification('Please place a bet first!', 'error');
                }
                return;
            }
            
            const currentBalance = parseInt((document.getElementById('balanceDisplay').textContent || '0').replace(/[^0-9]/g, '')) || 0;
            if (currentBalance < currentBet) {
                showNotification('üí≥ Insufficient DT Credits!', 'error');
                return;
            }
            
            // Deduct bet from balance
            const newBalance = currentBalance - currentBet;
            localStorage.setItem('vegasBalance', String(newBalance));
            document.getElementById('balanceDisplay').textContent = `$${newBalance}`;
            
            // Reset game state
            gameState = 'playing';
            playerHand = [];
            dealerHand = [];
            
            // Clear cards display
            document.getElementById('playerCards').innerHTML = '';
            document.getElementById('dealerCards').innerHTML = '';
            
            // Reset scores
            document.getElementById('playerScore').textContent = '0';
            document.getElementById('dealerScore').textContent = '0';
            
            // Update UI
            updateGameStatus('Dealing cards...');
            updateActionButtons();
            
            // Create deck if needed
            if (deck.length === 0) {
                createDeck();
            }
            
            // Deal cards sequentially with animation
            try {
                console.log('Starting sequential card dealing...');
                
                // Player first card
                const playerCard1 = drawCard();
                playerHand.push(playerCard1);
                addCardToHand('player', playerCard1);
                await new Promise(resolve => setTimeout(resolve, 600));
                
                // Dealer first card
                const dealerCard1 = drawCard();
                dealerHand.push(dealerCard1);
                addCardToHand('dealer', dealerCard1);
                await new Promise(resolve => setTimeout(resolve, 600));
                
                // Player second card
                const playerCard2 = drawCard();
                playerHand.push(playerCard2);
                addCardToHand('player', playerCard2);
                await new Promise(resolve => setTimeout(resolve, 600));
                
                // Dealer second card (hidden)
                const dealerCard2 = drawCard();
                dealerHand.push(dealerCard2);
                addCardToHand('dealer', { suit: 'hidden', rank: 'hidden' }, true);
                await new Promise(resolve => setTimeout(resolve, 600));
                
                console.log('All cards dealt sequentially');
                
            } catch (error) {
                console.error('Error during card dealing:', error);
            }
            
            const playerScore = calculateScore(playerHand);
            const dealerScore = calculateScore([dealerHand[0]]); // Only show first card
            
            // Update scores
            updateScores(playerScore, dealerScore);
            
            // Check for blackjack
            if (playerScore === 21) {
                gameState = 'finished';
                const dealerActualScore = calculateScore(dealerHand);
                await revealDealerCard();
                updateScores(playerScore, dealerActualScore);
                
                if (dealerActualScore === 21) {
                    handleGameEnd('push', 'Both blackjack! Push.', currentBet);
                } else {
                    handleGameEnd('blackjack', 'Blackjack! You win!', Math.floor(currentBet * 2.5));
                }
            } else {
                updateGameStatus('Your turn. Hit or stand?');
                updateActionButtons();
                updateStrategyHint();
            }
        }
        
        async function dealInitialCards(playerCards, dealerCards) {
            // Deal player cards with animation
            for (let i = 0; i < playerCards.length; i++) {
                await new Promise(resolve => setTimeout(resolve, 500));
                addCardToHand('player', playerCards[i]);
            }
            
            // Deal dealer cards (second card face down)
            for (let i = 0; i < dealerCards.length; i++) {
                await new Promise(resolve => setTimeout(resolve, 500));
                if (i === 1) {
                    addCardToHand('dealer', { suit: 'hidden', rank: 'hidden' }, true);
                } else {
                    addCardToHand('dealer', dealerCards[i]);
                }
            }
        }
        
        function addCardToHand(player, card, faceDown = false) {
            console.log(`Adding ${faceDown ? 'hidden' : 'visible'} card to ${player}:`, card);
            const container = document.getElementById(`${player}Cards`);
            if (!container) {
                console.error(`Container not found for ${player}Cards`);
                return;
            }
            
            try {
                const cardElement = createCardElement(card, faceDown);
                cardElement.classList.add('dealing');
                container.appendChild(cardElement);
                
                console.log(`Card added to ${player}. Container now has ${container.children.length} cards`);
                
                // Update deck stats (skip if elements don't exist)
                if (!faceDown && card.rank !== 'hidden') {
                    try {
                        updateDeckStats(card);
                    } catch (e) {
                        console.log('Skipping deck stats update:', e.message);
                    }
                }
            } catch (error) {
                console.error('Error adding card:', error);
            }
        }
        
        function createCardElement(card, faceDown = false) {
            const cardDiv = document.createElement('div');
            cardDiv.className = 'card';
            
            if (faceDown || card.rank === 'hidden') {
                cardDiv.className += ' card-back';
                cardDiv.innerHTML = 'üÉè';
                return cardDiv;
            }
            
            const isRed = card.suit === '‚ô•' || card.suit === '‚ô¶';
            cardDiv.className += isRed ? ' red' : ' black';
            
            const displayRank = card.rank === 1 ? 'A' : 
                               card.rank === 11 ? 'J' :
                               card.rank === 12 ? 'Q' :
                               card.rank === 13 ? 'K' : card.rank;
            
            cardDiv.innerHTML = `
                <div class="text-left">
                    <div>${displayRank}</div>
                    <div style="font-size: 16px;">${card.suit}</div>
                </div>
                <div class="text-center" style="font-size: 20px;">${card.suit}</div>
                <div class="text-right" style="transform: rotate(180deg);">
                    <div>${displayRank}</div>
                    <div style="font-size: 16px;">${card.suit}</div>
                </div>
            `;
            
            return cardDiv;
        }
        
        function calculateScore(hand) {
            let score = 0;
            let aces = 0;
            
            for (let card of hand) {
                if (card.rank === 1) {
                    aces++;
                    score += 11;
                } else if (card.rank >= 10) {
                    score += 10;
                } else {
                    score += card.rank;
                }
            }
            
            // Handle aces
            while (score > 21 && aces > 0) {
                score -= 10;
                aces--;
            }
            
            return score;
        }
        
        async function playerHit() {
            if (gameState !== 'playing') return;
            
            // Draw new card
            const newCard = drawCard();
            playerHand.push(newCard);
            
            // Add card with animation
            await new Promise(resolve => setTimeout(resolve, 300));
            addCardToHand('player', newCard);
            
            const playerScore = calculateScore(playerHand);
            updateScores(playerScore, null);
            
            console.log('Player score after hit:', playerScore);
            
            if (playerScore > 21) {
                console.log('Player busted!');
                gameState = 'finished';
                updateGameStatus('üí• BUST! You went over 21!');
                await new Promise(resolve => setTimeout(resolve, 1000));
                handleGameEnd('bust', 'You lose! Bust over 21.', 0);
            } else if (playerScore === 21) {
                // Auto-stand on 21
                updateGameStatus('Perfect 21! Standing automatically...');
                setTimeout(() => playerStand(), 1000);
            } else {
                updateGameStatus('Hit or stand?');
                updateStrategyHint();
            }
            
            updateActionButtons();
        }
        
        async function playerStand() {
            if (gameState !== 'playing') return;
            
            gameState = 'dealer_turn';
            updateGameStatus('Dealer\'s turn...');
            updateActionButtons();
            
            // Reveal dealer's hidden card
            await revealDealerCard();
            
            const playerScore = calculateScore(playerHand);
            let dealerScore = calculateScore(dealerHand);
            
            updateScores(playerScore, dealerScore);
            
            // Intelligent dealer AI - tries to beat player if they're close to 21
            let shouldHit = dealerScore < 17;
            
            // If player has a strong hand (18-20), dealer is more aggressive
            if (playerScore >= 18 && playerScore <= 20) {
                shouldHit = dealerScore < 18;
                if (playerScore === 20) {
                    shouldHit = dealerScore < 19; // Even more aggressive against 20
                }
            }
            
            // Dealer plays their hand
            while (shouldHit && dealerScore <= 21) {
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                const newCard = drawCard();
                dealerHand.push(newCard);
                addCardToHand('dealer', newCard);
                
                dealerScore = calculateScore(dealerHand);
                updateScores(playerScore, dealerScore);
                
                updateGameStatus(`Dealer draws... Score: ${dealerScore}`);
                
                // Update hit condition with intelligent AI
                if (playerScore >= 18 && playerScore <= 20) {
                    shouldHit = dealerScore < playerScore && dealerScore < 21;
                } else {
                    shouldHit = dealerScore < 17;
                }
            }
            
            // Determine winner with cheat boost
            gameState = 'finished';
            let finalResult, finalPayout = 0;
            
            if (dealerScore > 21) {
                finalResult = 'win';
                finalPayout = currentBet * 2;
            } else if (dealerScore > playerScore) {
                finalResult = 'lose';
                finalPayout = 0;
            } else if (dealerScore < playerScore) {
                finalResult = 'win';
                finalPayout = currentBet * 2;
            } else {
                finalResult = 'push';
                finalPayout = currentBet;
            }
            
            // Apply cheat boost if active and losing
            if (cheatState.active && finalResult === 'lose') {
                const cheat = cheatMethods[cheatState.active];
                if (Math.random() * 100 < cheat.winBoost) {
                    finalResult = 'win';
                    finalPayout = currentBet * 2;
                    
                    // Show cheat activation message
                    const cheatMsg = document.createElement('div');
                    cheatMsg.className = 'fixed top-20 left-1/2 transform -translate-x-1/2 text-2xl font-bold text-red-400 z-50 animate-pulse';
                    cheatMsg.textContent = `üéØ ${cheat.name} Activated!`;
                    document.body.appendChild(cheatMsg);
                    setTimeout(() => cheatMsg.remove(), 3000);
                }
            }
            
            // Handle game end
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            console.log('üèÅ DEALER TURN COMPLETE');
            console.log('   Player Score:', playerScore);
            console.log('   Dealer Score:', dealerScore);
            console.log('   Final Result:', finalResult);
            console.log('   Final Payout:', finalPayout);
            console.log('   Current Game State:', gameState);
            
            console.log('üéØ CALLING handleGameEnd...');
            
            if (finalResult === 'win') {
                const message = dealerScore > 21 ? 'Dealer busts! You win!' : 'You win!';
                console.log('   Calling WIN scenario:', message);
                handleGameEnd('win', message, finalPayout);
            } else if (finalResult === 'push') {
                console.log('   Calling PUSH scenario');
                handleGameEnd('push', 'Push! Tie game.', finalPayout);
            } else {
                console.log('   Calling LOSE scenario');
                handleGameEnd('lose', 'Dealer wins.', finalPayout);
            }
        }
        
        async function playerDouble() {
            if (gameState !== 'playing' || playerHand.length !== 2) return;
            
            const currentBalance = parseInt((document.getElementById('balanceDisplay').textContent || '0').replace(/[^0-9]/g, '')) || 0;
            if (currentBalance < currentBet) {
                showNotification('Insufficient balance to double!', 'error');
                return;
            }
            
            // Deduct additional bet amount
            const newBalance = currentBalance - currentBet;
            localStorage.setItem('vegasBalance', String(newBalance));
            document.getElementById('balanceDisplay').textContent = `$${newBalance}`;
            
            // Double the bet
            currentBet *= 2;
            document.getElementById('currentBet').textContent = `$${currentBet}`;
            
            // Draw one card
            const newCard = drawCard();
            playerHand.push(newCard);
            
            // Add card with animation
            await new Promise(resolve => setTimeout(resolve, 500));
            addCardToHand('player', newCard);
            
            const playerScore = calculateScore(playerHand);
            updateScores(playerScore, null);
            
            if (playerScore > 21) {
                gameState = 'finished';
                handleGameEnd('bust', 'Bust! You lose.', 0);
            } else {
                // Auto-stand after double
                updateGameStatus('Doubled down! Standing automatically...');
                setTimeout(() => playerStand(), 1000);
            }
        }
        
        async function revealDealerCard() {
            const dealerCards = document.getElementById('dealerCards');
            const hiddenCard = dealerCards.querySelector('.card-back');
            
            if (hiddenCard && dealerHand.length > 1) {
                hiddenCard.classList.add('flipping');
                
                setTimeout(() => {
                    const newCard = createCardElement(dealerHand[1]);
                    hiddenCard.replaceWith(newCard);
                    updateDeckStats(dealerHand[1]);
                }, 300);
            }
        }
        
        async function playDealerHand(finalHand, finalScore) {
            // Add any additional cards the dealer drew
            for (let i = 2; i < finalHand.length; i++) {
                await new Promise(resolve => setTimeout(resolve, 1000));
                addCardToHand('dealer', finalHand[i]);
            }
            
            dealerHand = finalHand;
            updateScores(null, finalScore);
        }
        
        function updateScores(playerScore, dealerScore) {
            if (playerScore !== null) {
                document.getElementById('playerScore').textContent = playerScore;
                const playerDisplay = document.getElementById('playerScoreDisplay');
                playerDisplay.classList.remove('bust', 'blackjack');
                
                if (playerScore > 21) {
                    playerDisplay.classList.add('bust');
                } else if (playerScore === 21 && playerHand.length === 2) {
                    playerDisplay.classList.add('blackjack');
                }
            }
            
            if (dealerScore !== null && gameState !== 'playing') {
                document.getElementById('dealerScore').textContent = dealerScore;
                const dealerDisplay = document.getElementById('dealerScoreDisplay');
                dealerDisplay.classList.remove('bust', 'blackjack');
                
                if (dealerScore > 21) {
                    dealerDisplay.classList.add('bust');
                } else if (dealerScore === 21 && dealerHand.length === 2) {
                    dealerDisplay.classList.add('blackjack');
                }
            }
        }
        
        function handleGameEnd(result, message, payout = 0) {
            console.log('üéØ ========== HANDLE GAME END CALLED ==========');
            console.log('   Result:', result);
            console.log('   Message:', message);
            console.log('   Payout:', payout);
            console.log('   Previous Game State:', gameState);
            console.log('============================================');
            
            // Force game state to finished to prevent any other calls
            gameState = 'finished';
            console.log('   New Game State:', gameState);
            
            // Update balance first if there's a payout
            if (payout > 0) {
                const currentBalance = parseInt(localStorage.getItem('vegasBalance') || '0');
                const newBalance = currentBalance + payout;
                localStorage.setItem('vegasBalance', String(newBalance));
                document.getElementById('balanceDisplay').textContent = `$${newBalance}`;
                console.log('üí∞ Balance updated to:', newBalance);
            }
            
            // Update stats
            updateGameStats(result, payout);
            
            // Show result message immediately and clearly
            const statusElement = document.getElementById('gameStatus');
            if (statusElement) {
                console.log('üì¢ Showing result message:', message);
                if (result === 'win' || result === 'blackjack') {
                    statusElement.innerHTML = `<span class="text-3xl font-bold text-green-400">üéâ ${message} üéâ</span>`;
                } else if (result === 'push') {
                    statusElement.innerHTML = `<span class="text-3xl font-bold text-yellow-400">ü§ù ${message} ü§ù</span>`;
                } else {
                    statusElement.innerHTML = `<span class="text-3xl font-bold text-red-400">${message}</span>`;
                }
            }
            
            // Disable all action buttons immediately
            ['hitButton', 'standButton', 'doubleButton'].forEach(id => {
                const btn = document.getElementById(id);
                if (btn) btn.disabled = true;
            });
            
            console.log('‚è∞ Setting 1 second timeout for table clear...');
            
            // Clear table after showing result
            setTimeout(() => {
                console.log('üßπ CLEARING TABLE NOW...');
                
                // Clear all cards from table
                document.getElementById('playerCards').innerHTML = '';
                document.getElementById('dealerCards').innerHTML = '';
                document.getElementById('playerScore').textContent = '0';
                document.getElementById('dealerScore').textContent = '0';
                
                // Reset all game variables
                gameState = 'waiting';
                playerHand = [];
                dealerHand = [];
                
                console.log('üîÑ Game state reset to waiting, hands cleared');
                
                // Reset status to normal and ready for next hand
                if (statusElement) {
                    statusElement.className = 'text-xl text-center py-2';
                    if (currentBet > 0) {
                        statusElement.innerHTML = `<span class="text-dt-cyan">üé∞ Ready! Click Deal Cards for next hand</span>`;
                    } else {
                        statusElement.innerHTML = `<span class="text-dt-cyan">üé∞ Place your bet to start playing!</span>`;
                    }
                }
                
                // Set button states correctly
                const dealButton = document.getElementById('dealButton');
                if (dealButton) {
                    dealButton.disabled = currentBet === 0;
                    dealButton.textContent = currentBet > 0 ? 'Deal Cards' : 'Place Bet First';
                    console.log('üé≤ Deal button state:', dealButton.disabled ? 'DISABLED' : 'ENABLED');
                }
                
                console.log('‚úÖ TABLE RESET COMPLETE - Bet:', currentBet, 'State:', gameState);
            }, 3000);
        }
        
        function resetTable() {
            console.log('Resetting blackjack table...');
            
            // Clear cards immediately
            const playerCardsEl = document.getElementById('playerCards');
            const dealerCardsEl = document.getElementById('dealerCards');
            if (playerCardsEl) playerCardsEl.innerHTML = '';
            if (dealerCardsEl) dealerCardsEl.innerHTML = '';
            
            // Reset scores
            const playerScoreEl = document.getElementById('playerScore');
            const dealerScoreEl = document.getElementById('dealerScore');
            if (playerScoreEl) playerScoreEl.textContent = '0';
            if (dealerScoreEl) dealerScoreEl.textContent = '0';
            
            // Reset game state completely
            gameState = 'waiting';
            playerHand = [];
            dealerHand = [];
            // Keep the current bet so players can continue playing
            
            console.log('Game state set to:', gameState);
            console.log('Current bet maintained at:', currentBet);
            
            // Force update UI
            updateActionButtons();
            
            // Set appropriate status message
            if (currentBet > 0) {
                updateGameStatus(`üé∞ Bet $${currentBet} placed - Click Deal to continue!`);
            } else {
                updateGameStatus('üé∞ Place your bet for the next hand!');
            }
            
            // Double-check the deal button is enabled
            const dealButton = document.getElementById('dealButton');
            if (dealButton && currentBet > 0) {
                dealButton.disabled = false;
                dealButton.textContent = 'Deal Cards';
                console.log('Deal button enabled - ready for next hand');
            }
            
            console.log('Table reset complete - ready for new game!');
        }
        
        function updateGameStats(result, payout) {
            gameStats.totalHands++;
            
            if (result === 'win' || result === 'blackjack') {
                gameStats.totalWins++;
            }
            
            if (result === 'blackjack') {
                gameStats.totalBlackjacks++;
            }
            
            if (result === 'push') {
                gameStats.totalPushes++;
            }
            
            gameStats.netProfit += (payout - currentBet);
            
            // Add to recent hands
            gameStats.recentHands.unshift({
                result: result,
                bet: currentBet,
                payout: payout,
                profit: payout - currentBet,
                timestamp: Date.now()
            });
            
            // Keep only last 10 hands
            if (gameStats.recentHands.length > 10) {
                gameStats.recentHands = gameStats.recentHands.slice(0, 10);
            }
            
            updateStatsDisplay();
        }
        
        function updateStatsDisplay() {
            // Add null checks to prevent errors if elements don't exist
            const totalHandsEl = document.getElementById('totalHands');
            const totalWinsEl = document.getElementById('totalWins');
            const totalBlackjacksEl = document.getElementById('totalBlackjacks');
            const winRateEl = document.getElementById('winRate');
            const profitElement = document.getElementById('netProfit');
            
            if (totalHandsEl) totalHandsEl.textContent = gameStats.totalHands;
            if (totalWinsEl) totalWinsEl.textContent = gameStats.totalWins;
            if (totalBlackjacksEl) totalBlackjacksEl.textContent = gameStats.totalBlackjacks;
            
            if (winRateEl) {
                const winRate = gameStats.totalHands > 0 ? 
                    ((gameStats.totalWins / gameStats.totalHands) * 100).toFixed(1) : 0;
                winRateEl.textContent = `${winRate}%`;
            }
            
            if (profitElement) {
                profitElement.textContent = `$${gameStats.netProfit}`;
                profitElement.className = gameStats.netProfit >= 0 ? 'font-mono text-dt-green' : 'font-mono text-red-400';
            }
            
            updateRecentHandsDisplay();
        }
        
        function updateRecentHandsDisplay() {
            const container = document.getElementById('recentHands');
            if (!container) return; // Exit if element doesn't exist
            
            container.innerHTML = '';
            
            if (gameStats.recentHands.length === 0) {
                container.innerHTML = '<div class="text-dt-light-gray text-center">No hands played yet</div>';
                return;
            }
            
            gameStats.recentHands.forEach(hand => {
                const handDiv = document.createElement('div');
                handDiv.className = 'flex justify-between items-center p-2 bg-dt-darker rounded border border-dt-gray/30';
                
                let resultColor = 'text-dt-light-gray';
                let resultText = hand.result;
                
                if (hand.result === 'win' || hand.result === 'blackjack') {
                    resultColor = 'text-dt-green';
                    resultText = hand.result === 'blackjack' ? 'BJ' : 'W';
                } else if (hand.result === 'push') {
                    resultColor = 'text-dt-yellow';
                    resultText = 'P';
                } else {
                    resultColor = 'text-red-400';
                    resultText = 'L';
                }
                
                handDiv.innerHTML = `
                    <div class="flex items-center space-x-2">
                        <div class="text-xs bg-dt-gray px-2 py-1 rounded ${resultColor} font-bold">
                            ${resultText}
                        </div>
                        <div class="text-xs text-dt-light-gray">$${hand.bet}</div>
                    </div>
                    <div class="text-right text-xs">
                        <div class="${hand.profit >= 0 ? 'text-dt-green' : 'text-red-400'}">
                            ${hand.profit >= 0 ? '+' : ''}$${hand.profit}
                        </div>
                    </div>
                `;
                container.appendChild(handDiv);
            });
        }
        
        function updateDeckStats(card) {
            deckStats.cardsDealt++;
            
            // Update high/low card counts for basic card counting
            if (card.rank >= 10 || card.rank === 1) {
                deckStats.highCards--;
                deckStats.runningCount--;
            } else if (card.rank >= 2 && card.rank <= 6) {
                deckStats.lowCards--;
                deckStats.runningCount++;
            }
            
            // Update DOM elements only if they exist
            const cardsDealtEl = document.getElementById('cardsDealt');
            const highCardsEl = document.getElementById('highCards');
            const lowCardsEl = document.getElementById('lowCards');
            const runningCountEl = document.getElementById('runningCount');
            const deckPenetrationEl = document.getElementById('deckPenetration');
            
            if (cardsDealtEl) cardsDealtEl.textContent = `${deckStats.cardsDealt}/52`;
            if (highCardsEl) highCardsEl.textContent = Math.max(0, deckStats.highCards);
            if (lowCardsEl) lowCardsEl.textContent = Math.max(0, deckStats.lowCards);
            if (runningCountEl) runningCountEl.textContent = deckStats.runningCount > 0 ? `+${deckStats.runningCount}` : deckStats.runningCount;
            if (deckPenetrationEl) {
                const penetration = (deckStats.cardsDealt / 52) * 100;
                deckPenetrationEl.style.width = `${penetration}%`;
            }
        }
        
        function updateActionButtons() {
            const dealButton = document.getElementById('dealButton');
            const hitButton = document.getElementById('hitButton');
            const standButton = document.getElementById('standButton');
            const doubleButton = document.getElementById('doubleButton');
            
            // Reset all buttons
            [dealButton, hitButton, standButton, doubleButton].forEach(btn => {
                btn.disabled = true;
            });
            
            switch (gameState) {
                case 'waiting':
                    if (currentBet > 0) {
                        dealButton.disabled = false;
                        dealButton.textContent = 'Deal Cards';
                    } else {
                        dealButton.disabled = true;
                        dealButton.textContent = 'Place Bet First';
                    }
                    break;
                    
                case 'playing':
                    hitButton.disabled = false;
                    standButton.disabled = false;
                    doubleButton.disabled = playerHand.length !== 2 || 
                        parseInt(localStorage.getItem('vegasBalance') || '0') < currentBet;
                    break;
                    
                case 'dealer_turn':
                case 'finished':
                    // All buttons disabled
                    break;
            }
        }
        
        function updateGameStatus(message) {
            document.getElementById('gameStatus').innerHTML = `
                <span class="text-dt-cyan">${message}</span>
            `;
        }
        
        function updateStrategyHint() {
            const hintElement = document.getElementById('strategyHint');
            if (!hintElement) return; // Exit if element doesn't exist
            
            if (gameState === 'waiting') {
                hintElement.textContent = currentBet > 0 ? 
                    'Ready to deal! Click "Deal Cards" to start.' :
                    'Place a bet to receive AI-powered strategy recommendations.';
                return;
            }
            
            if (gameState !== 'playing' || playerHand.length === 0) {
                hintElement.textContent = 'Game in progress...';
                return;
            }
            
            const playerScore = calculateScore(playerHand);
            const dealerUpCard = dealerHand[0];
            const dealerValue = dealerUpCard.rank === 1 ? 11 : Math.min(dealerUpCard.rank, 10);
            
            let hint = '';
            
            // Basic strategy recommendations
            if (playerScore < 12) {
                hint = 'üìà Always HIT with score under 12';
            } else if (playerScore >= 17) {
                hint = 'üõë Always STAND with score 17 or higher';
            } else if (playerScore === 16) {
                hint = dealerValue >= 7 ? '‚ö° HIT vs dealer 7-A' : 'üõë STAND vs dealer 2-6';
            } else if (playerScore === 15) {
                hint = dealerValue >= 7 ? '‚ö° HIT vs dealer 7-A' : 'üõë STAND vs dealer 2-6';
            } else if (playerScore >= 13 && playerScore <= 14) {
                hint = dealerValue >= 7 ? '‚ö° HIT vs dealer 7-A' : 'üõë STAND vs dealer 2-6';
            } else if (playerScore === 12) {
                hint = (dealerValue >= 4 && dealerValue <= 6) ? 'üõë STAND vs dealer 4-6' : '‚ö° HIT vs other cards';
            }
            
            // Double down recommendations
            if (playerHand.length === 2) {
                if (playerScore === 11) {
                    hint = 'üíé DOUBLE DOWN with 11 (if possible)';
                } else if (playerScore === 10 && dealerValue < 10) {
                    hint = 'üíé Consider DOUBLE DOWN with 10 vs dealer 2-9';
                } else if (playerScore === 9 && dealerValue >= 3 && dealerValue <= 6) {
                    hint = 'üíé Consider DOUBLE DOWN with 9 vs dealer 3-6';
                }
            }
            
            hintElement.textContent = hint || 'Analyze the situation carefully...';
        }
        
        function calculateScore(hand) {
            let score = 0;
            let aces = 0;
            
            for (let card of hand) {
                if (card.rank === 1) {
                    aces++;
                    score += 11;
                } else {
                    score += Math.min(card.rank, 10);
                }
            }
            
            while (score > 21 && aces > 0) {
                score -= 10;
                aces--;
            }
            
            return score;
        }
        
        async function addFunds() {
            const username = localStorage.getItem('vegas.username') || localStorage.getItem('vegasUser') || 'Anonymous';
            try {
                const resp = await fetch('/api/user/topup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ Username: username, Amount: 500 })
                });
                const data = await resp.json();
                if (typeof data.balance === 'number') {
                    localStorage.setItem('vegasBalance', String(data.balance));
                    updateBalanceDisplay();
                    showNotification('üí∞ $500 added to your balance!', 'success');
                } else {
                    showNotification('Top-up failed to persist.', 'error');
                }
            } catch (e) {
                showNotification('Top-up request failed.', 'error');
            }
        }
        
        function updateBalance(change) {
            const currentBalance = parseInt(localStorage.getItem('vegasBalance') || '0');
            const newBalance = Math.max(0, currentBalance + change);
            localStorage.setItem('vegasBalance', newBalance);
            updateBalanceDisplay();
        }
        
        function updateBalanceDisplay() {
            const balance = localStorage.getItem('vegasBalance') || '0';
            document.getElementById('balanceDisplay').textContent = `$${balance}`;
        }
        
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-6 right-6 z-50 p-4 rounded-lg shadow-lg ${
                type === 'success' ? 'bg-dt-green text-white' : 
                type === 'error' ? 'bg-red-500 text-white' : 
                'bg-dt-blue text-white'
            }`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // Animate in
            gsap.from(notification, {
                duration: 0.3,
                x: 100,
                opacity: 0,
                ease: "back.out(1.7)"
            });
            
            // Auto remove
            setTimeout(() => {
                gsap.to(notification, {
                    duration: 0.3,
                    x: 100,
                    opacity: 0,
                    ease: "back.in(1.7)",
                    onComplete: () => notification.remove()
                });
            }, 3000);
        }
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            const username = localStorage.getItem('vegas.username') || localStorage.getItem('vegasUser') || 'Agent';
            document.getElementById('agentName').textContent = username;
            
            // Initialize balance if not set
            if (!localStorage.getItem('vegasBalance')) {
                localStorage.setItem('vegasBalance', '1000');
            }
            updateBalanceDisplay();
            
            // Initialize deck
            createDeck();
            
            updateActionButtons();
            updateStrategyHint();
            
            // Animate page entrance
            gsap.from('.blackjack-table', {
                duration: 1,
                scale: 0.9,
                opacity: 0,
                ease: "back.out(1.7)"
            });
            
            gsap.from('.betting-area', {
                duration: 0.8,
                y: 50,
                opacity: 0,
                stagger: 0.2,
                ease: "back.out(1.7)",
                delay: 0.3
            });
        });

        // Add funds function for deposit button
        function addFunds() {
            const currentBalance = parseInt(localStorage.getItem('vegasBalance') || '1000');
            const newBalance = currentBalance + 1000;
            localStorage.setItem('vegasBalance', String(newBalance));
            
            updateBalanceDisplay();
            console.log(`üí∞ Added $1000 credits! New balance: $${newBalance}`);
        }

        // Update balance display with $ currency
        function updateBalanceDisplay() {
            const balance = localStorage.getItem('vegasBalance') || '1000';
            const balanceElement = document.getElementById('balanceDisplay');
            if (balanceElement) {
                balanceElement.textContent = `$${balance}`;
            }
        }

        // Initialize user info
        document.addEventListener('DOMContentLoaded', function() {
            const username = localStorage.getItem('vegas.username') || localStorage.getItem('vegasUser') || 'Agent';
            const agentNameElement = document.getElementById('agentName');
            if (agentNameElement) {
                agentNameElement.textContent = username;
            }
            updateBalanceDisplay();
        });
        
        // Socket event handlers
        socket.on('connect', () => {
            console.log('üîå Connected to blackjack game');
        });
    </script>
</body>
</html>